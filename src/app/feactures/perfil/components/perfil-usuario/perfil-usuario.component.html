<div class="perfil-container">
  <!-- Toast para notificaciones -->
  <p-toast></p-toast>

  <!-- Header del perfil -->
  <div class="perfil-header">
    <h2 class="perfil-title">
      <i class="pi pi-user"></i>
      Mi Perfil
    </h2>
    <p class="perfil-subtitle">
      Gestiona tu información personal y estado de pareja
    </p>
  </div>

  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-state">
    <app-loading-spinner
      size="large"
      label="Cargando perfil..."
      [overlay]="false"
      styleClass="profile-spinner"
    />
    <div class="loading-message">
      <h3>Estamos preparando tu información personal</h3>
      <p>Un momento por favor...</p>
    </div>
  </div>

  <!-- Estado de error -->
  <div *ngIf="error && !loading" class="error-state mb-4">
    <p-card styleClass="error-card">
      <div class="error-content text-center p-4">
        <div class="error-icon mb-4">
          <i class="pi pi-exclamation-triangle text-4xl text-danger"></i>
        </div>
        <h3 class="text-xl font-bold text-900 mb-3">Error al cargar perfil</h3>
        <p class="text-500 mb-4">{{ error }}</p>

        <!-- Botones de acción -->
        <div class="error-actions mb-4">
          <p-button
            label="Reintentar"
            icon="pi pi-refresh"
            (onClick)="cargarPerfilUsuario()"
            severity="secondary"
            size="large">
          </p-button>
        </div>

        <!-- Información adicional -->
        <div class="error-info p-3 bg-gray-50 rounded">
          <p class="text-sm text-600">
            <i class="pi pi-info-circle"></i>
            Verifica tu conexión a internet e intenta nuevamente.
          </p>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Contenido del perfil -->
  <div *ngIf="!loading && !error" class="perfil-content">

    <!-- Información del usuario -->
    <div class="perfil-section">
      <h3 class="section-title">
        <i class="pi pi-user"></i>
        Información Personal
      </h3>

      <div class="usuario-info p-4">
        <div class="avatar-section">
          <p-avatar
            [label]="getNombreCompleto().charAt(0)"
            size="xlarge"
            shape="circle"
            styleClass="usuario-avatar">
          </p-avatar>
                     <div class="avatar-actions">
             <p-button
               icon="pi pi-camera"
               [text]="true"
               size="small"
               styleClass="avatar-camera-btn"
               pTooltip="Cambiar foto">
             </p-button>
           </div>
        </div>

        <div class="datos-usuario">
          <div class="nombre-section mb-4">
            <h2 class="text-3xl font-bold text-900 mb-2">{{ getNombreCompleto() }}</h2>
            <p class="username text-lg font-semibold text-primary mb-2">{{ '@' + (usuario?.username || '') }}</p>
            <p class="email text-500">{{ usuario?.correo }}</p>
          </div>

                     <!-- Formulario de edición -->
           <div *ngIf="editMode" class="edit-form-wrapper">
             <form [formGroup]="editForm" class="edit-form">
               <!-- Nombres y Apellidos -->
               <div class="form-row">
                 <div class="form-field">
                   <label for="nombre" class="field-label">
                     Nombre <span class="required">*</span>
                   </label>
                   <input
                     type="text"
                     pInputText
                     id="nombre"
                     formControlName="nombre"
                     placeholder="Tu nombre"
                     [class.field-error]="isFieldInvalid('nombre')"
                     class="field-input"
                     autocomplete="given-name"
                   />
                   <small *ngIf="isFieldInvalid('nombre')" class="error-message">
                     <i class="pi pi-exclamation-circle"></i>
                     {{ getFieldError('nombre') }}
                   </small>
                 </div>

                 <div class="form-field">
                   <label for="apellido" class="field-label">
                     Apellido <span class="required">*</span>
                   </label>
                   <input
                     type="text"
                     pInputText
                     id="apellido"
                     formControlName="apellido"
                     placeholder="Tu apellido"
                     [class.field-error]="isFieldInvalid('apellido')"
                     class="field-input"
                     autocomplete="family-name"
                   />
                   <small *ngIf="isFieldInvalid('apellido')" class="error-message">
                     <i class="pi pi-exclamation-circle"></i>
                     {{ getFieldError('apellido') }}
                   </small>
                 </div>
               </div>

               <!-- Email -->
               <div class="form-field">
                 <label for="correo" class="field-label">
                   Correo Electrónico <span class="required">*</span>
                 </label>
                 <input
                   type="email"
                   pInputText
                   id="correo"
                   formControlName="correo"
                   placeholder="tu@email.com"
                   [class.field-error]="isFieldInvalid('correo')"
                   class="field-input"
                   autocomplete="email"
                 />
                 <small *ngIf="isFieldInvalid('correo')" class="error-message">
                   <i class="pi pi-exclamation-circle"></i>
                   {{ getFieldError('correo') }}
                 </small>
               </div>

               <!-- Usuario -->
               <div class="form-field">
                 <label for="username" class="field-label">
                   Nombre de Usuario <span class="required">*</span>
                 </label>
                 <input
                   type="text"
                   pInputText
                   id="username"
                   formControlName="username"
                   placeholder="Tu nombre de usuario"
                   [class.field-error]="isFieldInvalid('username')"
                   class="field-input"
                   autocomplete="username"
                 />
                 <small *ngIf="isFieldInvalid('username')" class="error-message">
                   <i class="pi pi-exclamation-circle"></i>
                   {{ getFieldError('username') }}
                 </small>
               </div>

               <!-- Fecha de Nacimiento y Género -->
               <div class="form-row">
                 <div class="form-field">
                   <label for="fechaNacimiento" class="field-label">
                     Fecha de Nacimiento <span class="required">*</span>
                   </label>
                   <input
                     type="date"
                     id="fechaNacimiento"
                     formControlName="fechaNacimiento"
                     class="field-input"
                     [class.field-error]="isFieldInvalid('fechaNacimiento')"
                     placeholder="dd/mm/aaaa"
                   />
                   <small *ngIf="isFieldInvalid('fechaNacimiento')" class="error-message">
                     <i class="pi pi-exclamation-circle"></i>
                     {{ getFieldError('fechaNacimiento') }}
                   </small>
                 </div>

                 <div class="form-field">
                   <label for="genero" class="field-label">
                     Género <span class="required">*</span>
                   </label>
                   <p-select
                     [options]="generos"
                     formControlName="genero"
                     optionLabel="label"
                     optionValue="value"
                     [showClear]="true"
                     placeholder="Selecciona tu género"
                     class="field-input"
                     [class.field-error]="isFieldInvalid('genero')"
                     [filter]="false"
                     appendTo="body"
                   />
                   <small *ngIf="isFieldInvalid('genero')" class="error-message">
                     <i class="pi pi-exclamation-circle"></i>
                     {{ getFieldError('genero') }}
                   </small>
                 </div>
               </div>
             </form>
           </div>

          <div class="detalles-adicionales grid gap-3 mb-4">
            <div class="detalle-item" *ngIf="usuario?.fechaNacimiento">
              <i class="pi pi-calendar text-primary"></i>
              <span>{{ usuario?.fechaNacimiento | date:'dd/MM/yyyy' }}</span>
              <span class="edad text-600 ml-2" *ngIf="getEdad() > 0">({{ getEdad() }} años)</span>
            </div>
            <div class="detalle-item" *ngIf="usuario?.genero">
              <i class="pi pi-user text-primary"></i>
              <span>{{ getGeneroTexto() }}</span>
            </div>
            <div class="detalle-item">
              <i class="pi pi-shield text-primary"></i>
              <span><strong>Rol:</strong> {{ getRoleTexto() }}</span>
            </div>
            <div class="detalle-item">
              <i class="pi pi-check-circle text-primary"></i>
              <span><strong>Estado:</strong> {{ usuario?.enabled ? 'Activo' : 'Inactivo' }}</span>
            </div>
                         <!-- Código de Relación -->
                         <div class="detalle-item codigo-relacion">
                           <i class="pi pi-heart text-primary"></i>
                           <div class="codigo-content">
                             <span><strong>Código de Relación:</strong></span>

                             <!-- Mostrar código existente -->
                             <div *ngIf="usuario && usuario.codigoRelacion && !mostrandoCodigo" class="codigo-existente">
                                                               <span class="codigo-text">{{ formatearCodigo(usuario.codigoRelacion || '') }}</span>
                               <div class="codigo-actions">
                                 <p-button
                                   icon="pi pi-copy"
                                   [text]="true"
                                   size="small"
                                   pTooltip="Copiar código"
                                   (onClick)="copiarCodigo()">
                                 </p-button>
                                 <p-button
                                   icon="pi pi-refresh"
                                   [text]="true"
                                   size="small"
                                   pTooltip="Generar nuevo código"
                                   (onClick)="generarCodigoRelacion()">
                                 </p-button>
                               </div>
                             </div>

                             <!-- Mostrar código generado -->
                             <div *ngIf="mostrandoCodigo && codigoGenerado" class="codigo-generado">
                               <span class="codigo-text nuevo">{{ formatearCodigo(codigoGenerado) }}</span>
                               <div class="codigo-actions">
                                 <p-button
                                   icon="pi pi-copy"
                                   [text]="true"
                                   size="small"
                                   pTooltip="Copiar código"
                                   (onClick)="copiarCodigo()">
                                 </p-button>
                                 <p-button
                                   icon="pi pi-eye-slash"
                                   [text]="true"
                                   size="small"
                                   pTooltip="Ocultar código"
                                   (onClick)="ocultarCodigo()">
                                 </p-button>
                               </div>
                             </div>

                             <!-- Botón para generar código si no existe -->
                             <div *ngIf="!usuario?.codigoRelacion && !mostrandoCodigo" class="generar-codigo">
                               <p-button
                                 label="Generar Código"
                                 icon="pi pi-plus"
                                 [outlined]="true"
                                 size="small"
                                 [loading]="generandoCodigo"
                                 (onClick)="generarCodigoRelacion()">
                               </p-button>
                             </div>
                           </div>
                         </div>
          </div>

                     <!-- Acciones del perfil -->
           <div class="acciones-perfil flex gap-3">
             <p-button
               *ngIf="!editMode"
               label="Editar Perfil"
               icon="pi pi-pencil"
               [outlined]="true"
               size="large"
               styleClass="edit-btn"
               (onClick)="activarEdicion()">
             </p-button>
             <p-button
               *ngIf="editMode"
               label="Guardar"
               icon="pi pi-check"
               [loading]="saving"
               size="large"
               styleClass="save-btn"
               (onClick)="guardarCambios()">
             </p-button>
             <p-button
               *ngIf="editMode"
               label="Cancelar"
               icon="pi pi-times"
               [outlined]="true"
               severity="secondary"
               size="large"
               styleClass="cancel-btn"
               (onClick)="cancelarEdicion()">
             </p-button>
                              <p-button
                   label="Cambiar Contraseña"
                   icon="pi pi-key"
                   [outlined]="true"
                   size="large"
                   styleClass="password-btn"
                   (onClick)="showPasswordDialog()">
                 </p-button>
           </div>
        </div>
      </div>
    </div>

    <!-- Estado de pareja -->
    <div class="perfil-section">
      <h3 class="section-title">
        <i class="pi pi-heart"></i>
        Estado de Pareja
      </h3>

      <div class="pareja-info p-4">
        <!-- Con pareja -->
        <div *ngIf="tienePareja()" class="pareja-activa text-center">
          <div class="status-section mb-4">
            <div class="status-badge activa">
              <i class="pi pi-heart-fill"></i>
              <span>Pareja Activa</span>
            </div>
            <div class="pareja-details max-w-md mx-auto">
              <div class="detalle-item">
                <strong>Estado:</strong> {{ getEstadoPareja() }}
              </div>
              <div class="detalle-item" *ngIf="pareja?.fechaCreacion">
                <strong>Desde:</strong> {{ pareja?.fechaCreacion | date:'dd/MM/yyyy' }}
              </div>
              <div class="detalle-item" *ngIf="pareja?.usuario1Nombre && pareja?.usuario2Nombre">
                <strong>Integrantes:</strong> {{ pareja?.usuario1Nombre }} & {{ pareja?.usuario2Nombre }}
              </div>
            </div>
          </div>

          <div class="pareja-actions">
            <p-button
              label="Ver Perfil de Pareja"
              icon="pi pi-eye"
              [outlined]="true"
              size="large">
            </p-button>
          </div>
        </div>

        <!-- Sin pareja -->
        <div *ngIf="!tienePareja()" class="sin-pareja text-center">
          <div class="status-section mb-4">
            <div class="status-badge inactiva">
              <i class="pi pi-heart"></i>
              <span>Sin Pareja</span>
            </div>
            <p class="mensaje-sin-pareja text-500 text-lg mb-4">
              No tienes una pareja vinculada actualmente. ¡Conecta con alguien especial!
            </p>
          </div>

          <div class="acciones-pareja flex gap-3 justify-center flex-wrap">
            <p-button
              label="Buscar Pareja"
              icon="pi pi-search"
              styleClass="search-btn"
              size="large">
            </p-button>
            <p-button
              label="Invitar por Username"
              icon="pi pi-user-plus"
              [outlined]="true"
              styleClass="invite-btn"
              size="large">
            </p-button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Dialog de cambio de contraseña -->
<p-dialog
  header="Cambiar Contraseña"
  [(visible)]="passwordDialogVisible"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="password-dialog"
  (onHide)="hidePasswordDialog()"
>
  <form [formGroup]="passwordForm" class="password-form">
    <!-- Contraseña actual -->
    <div class="form-field">
      <label for="currentPassword" class="field-label">
        Contraseña Actual <span class="required">*</span>
      </label>
      <p-password
        id="currentPassword"
        formControlName="currentPassword"
        [toggleMask]="true"
        [feedback]="false"
        placeholder="Ingresa tu contraseña actual"
        [class.field-error]="isPasswordFieldInvalid('currentPassword')"
        styleClass="field-input"
        autocomplete="current-password"
      />
      <small *ngIf="isPasswordFieldInvalid('currentPassword')" class="error-message">
        <i class="pi pi-exclamation-circle"></i>
        {{ getPasswordFieldError('currentPassword') }}
      </small>
    </div>

    <!-- Nueva contraseña -->
    <div class="form-field">
      <label for="newPassword" class="field-label">
        Nueva Contraseña <span class="required">*</span>
      </label>
      <p-password
        id="newPassword"
        formControlName="newPassword"
        [toggleMask]="true"
        [feedback]="true"
        placeholder="Ingresa tu nueva contraseña"
        [class.field-error]="isPasswordFieldInvalid('newPassword')"
        styleClass="field-input"
        autocomplete="new-password"
      />
      <small *ngIf="isPasswordFieldInvalid('newPassword')" class="error-message">
        <i class="pi pi-exclamation-circle"></i>
        {{ getPasswordFieldError('newPassword') }}
      </small>
    </div>

    <!-- Confirmar nueva contraseña -->
    <div class="form-field">
      <label for="Password" class="field-label">
        Confirmar Nueva Contraseña <span class="required">*</span>
      </label>
      <p-password
        id="confirmPassword"
        formControlName="confirmPassword"
        [toggleMask]="true"
        [feedback]="false"
        placeholder="Confirma tu nueva contraseña"
        [class.field-error]="isPasswordFieldInvalid('confirmPassword')"
        styleClass="field-input"
        autocomplete="new-password"
      />
      <small *ngIf="isPasswordFieldInvalid('confirmPassword')" class="error-message">
        <i class="pi pi-exclamation-circle"></i>
        {{ getPasswordFieldError('confirmPassword') }}
      </small>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        [outlined]="true"
        severity="secondary"
        (onClick)="hidePasswordDialog()"
      />
      <p-button
        label="Cambiar Contraseña"
        icon="pi pi-key"
        [loading]="changingPassword"
        [disabled]="passwordForm.invalid"
        (onClick)="cambiarContrasena()"
        styleClass="change-password-btn"
      />
    </div>
  </ng-template>
</p-dialog>
