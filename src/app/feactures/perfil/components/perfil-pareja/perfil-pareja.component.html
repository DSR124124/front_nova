<div class="perfil-pareja-container">

  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-state">
    <p-progressSpinner />
    <p>Cargando información de la pareja...</p>
  </div>

  <!-- Estado de error -->
  <p-message
    *ngIf="error && !loading"
    severity="error"
    [text]="error">
  </p-message>

  <!-- Sin pareja -->
  <div *ngIf="!loading && !error && !pareja" class="sin-pareja">
    <p-card header="Sin Pareja">
      <p-message
        severity="info"
        text="No tienes una pareja vinculada actualmente. Puedes formar una pareja ingresando el código de relación de otro usuario.">
      </p-message>

      <!-- Formulario para formar pareja -->
      <div class="formulario-pareja">
        <h5>Formar Pareja</h5>

        <form [formGroup]="formPareja" (ngSubmit)="validarCodigoRelacion()">
          <div class="campo-codigo">
            <label for="codigoRelacion">Código de Relación:</label>
            <input
              id="codigoRelacion"
              type="text"
              pInputText
              formControlName="codigoRelacion"
              placeholder="Ingresa el código de relación"
              [class.ng-invalid]="isFieldInvalid('codigoRelacion')"
              [class.ng-dirty]="isFieldInvalid('codigoRelacion')"
            />
            <small *ngIf="isFieldInvalid('codigoRelacion')" class="p-error">
              {{ getFieldError('codigoRelacion') }}
            </small>
          </div>

          <div class="acciones-formulario">
            <p-button
              type="submit"
              label="Validar Código"
              icon="pi pi-check"
              [loading]="validandoCodigo"
              [disabled]="formPareja.invalid || validandoCodigo">
            </p-button>

            <p-button
              type="button"
              label="Limpiar"
              icon="pi pi-times"
              styleClass="p-button-outlined p-button-secondary"
              (click)="limpiarFormulario()">
            </p-button>
          </div>
        </form>

        <!-- Usuario encontrado -->
        <div *ngIf="codigoValido && usuarioEncontrado" class="usuario-encontrado">
          <p-card header="Usuario Encontrado" styleClass="usuario-card">
            <div class="usuario-info">
              <p-avatar
                [label]="getIniciales(usuarioEncontrado)"
                size="large"
                shape="circle">
              </p-avatar>

              <div class="datos-usuario">
                <h4>{{ getNombreCompleto(usuarioEncontrado) }}</h4>
                <p class="username">{{ '@' + usuarioEncontrado.username }}</p>
                <p class="email">{{ usuarioEncontrado.correo }}</p>
              </div>
            </div>

            <div class="acciones-usuario">
              <p-button
                label="Formar Pareja"
                icon="pi pi-heart"
                styleClass="p-button-success"
                (click)="formarPareja()"
                [loading]="loading">
              </p-button>
            </div>
          </p-card>
        </div>
      </div>

      <!-- Generar mi código -->
      <div class="mi-codigo">
        <h5>Mi Código de Relación</h5>
        <p-message
          *ngIf="usuarioActual?.codigoRelacion"
          severity="info"
          [text]="'Tu código: ' + (usuarioActual?.codigoRelacion || '')">
        </p-message>

        <p-button
          *ngIf="!usuarioActual?.codigoRelacion"
          label="Generar Código"
          icon="pi pi-key"
          styleClass="p-button-outlined p-button-info"
          (click)="generarMiCodigo()"
          [loading]="loading">
        </p-button>
      </div>
    </p-card>
  </div>

  <!-- Con pareja -->
  <div *ngIf="!loading && !error && pareja" class="con-pareja">

    <!-- Información general de la pareja -->
    <p-card header="Información de la Pareja">
      <div class="pareja-info">

        <!-- Estado de la relación -->
        <div class="estado-relacion">
          <p-tag
            [value]="getEstadoInfo().label"
            [icon]="getEstadoInfo().icon"
            [severity]="getEstadoInfo().color">
          </p-tag>
        </div>

        <!-- Tiempo juntos -->
        <div class="tiempo-juntos">
          <h5>Tiempo Juntos</h5>
          <p-chip
            [label]="calcularTiempoJuntos()"
            icon="pi pi-calendar">
          </p-chip>
        </div>

        <!-- Fecha de inicio -->
        <div class="fecha-inicio">
          <h5>Fecha de Inicio</h5>
          <p>{{ pareja.fechaCreacion | date:'dd/MM/yyyy' }}</p>
        </div>
      </div>
    </p-card>

    <!-- Información del compañero -->
    <p-card header="Tu Compañero/a">
      <div class="companero-info">

        <!-- Avatar y datos básicos -->
        <div class="companero-principal">
          <p-avatar
            [label]="getIniciales(companero)"
            size="large"
            shape="circle">
          </p-avatar>

          <div class="datos-companero">
            <h4>{{ getNombreCompleto(companero) }}</h4>
            <p class="username">{{ '@' + (companero?.username || '') }}</p>
            <p class="email">{{ companero?.correo }}</p>
          </div>
        </div>

        <!-- Detalles adicionales -->
        <div class="detalles-companero">
          <div class="detalle-item" *ngIf="companero?.fechaNacimiento">
            <p-chip
              label="Nacimiento"
              icon="pi pi-calendar">
            </p-chip>
            <span>{{ companero?.fechaNacimiento | date:'dd/MM/yyyy' }}</span>
          </div>

          <div class="detalle-item" *ngIf="companero?.genero">
            <p-chip
              label="Género"
              icon="pi pi-user">
            </p-chip>
            <span>{{ companero?.genero === 'M' ? 'Masculino' : companero?.genero === 'F' ? 'Femenino' : 'Otro' }}</span>
          </div>
        </div>
      </div>
    </p-card>

    <!-- Acciones de pareja -->
    <p-card header="Acciones">
      <div class="acciones-pareja">
        <p-button
          label="Ver Chat"
          icon="pi pi-comments"
          styleClass="p-button-success">
        </p-button>

        <p-button
          label="Ver Citas"
          icon="pi pi-calendar"
          styleClass="p-button-info">
        </p-button>

        <p-button
          label="Ver Eventos"
          icon="pi pi-star"
          styleClass="p-button-warning">
        </p-button>

        <p-button
          label="Configurar Pareja"
          icon="pi pi-cog"
          styleClass="p-button-outlined">
        </p-button>
      </div>
    </p-card>

  </div>
</div>
