<div class="perfil-pareja-container">

  <!-- Header del perfil -->
  <div class="perfil-header">
    <h2 class="perfil-title">
      <i class="pi pi-heart"></i>
      Mi Perfil de Pareja
    </h2>
    <p class="perfil-subtitle">
      Gestiona tu relación y configuración de pareja
    </p>
  </div>

  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-state">
    <p-progressSpinner />
    <p>Cargando información de la pareja...</p>
  </div>

  <!-- Estado de error -->
  <p-message
    *ngIf="error && !loading"
    severity="error"
    [text]="error">
  </p-message>

  <!-- Sin pareja -->
  <div *ngIf="!loading && !error && disponibleParaPareja" class="sin-pareja">
    <p-card header="Sin Pareja">
      <p-message
        severity="info"
        text="No tienes una pareja vinculada actualmente. Puedes formar una pareja uniendo dos códigos de relación.">
      </p-message>

      <!-- Formulario para unir códigos -->
      <div class="formulario-pareja">
        <h5>Formar Pareja</h5>
        <p class="descripcion-formulario">
          Para formar una pareja, necesitas dos códigos de relación. Ingresa ambos códigos para crear la vinculación.
        </p>

        <form [formGroup]="formUnirCodigos" (ngSubmit)="unirCodigos()">
          <div class="campos-codigos">
            <div class="campo-codigo">
              <label for="codigo1">Primer Código:</label>
              <input
                id="codigo1"
                type="text"
                pInputText
                formControlName="codigo1"
                placeholder="Ingresa el primer código"
                [class.ng-invalid]="isFieldInvalid('codigo1')"
                [class.ng-dirty]="isFieldInvalid('codigo1')"
              />
              <small *ngIf="isFieldInvalid('codigo1')" class="p-error">
                {{ getFieldError('codigo1') }}
              </small>
            </div>

            <div class="campo-codigo">
              <label for="codigo2">Segundo Código:</label>
              <input
                id="codigo2"
                type="text"
                pInputText
                formControlName="codigo2"
                placeholder="Ingresa el segundo código"
                [class.ng-invalid]="isFieldInvalid('codigo2')"
                [class.ng-dirty]="isFieldInvalid('codigo2')"
              />
              <small *ngIf="isFieldInvalid('codigo2')" class="p-error">
                {{ getFieldError('codigo2') }}
              </small>
            </div>
          </div>

          <div class="acciones-formulario">
            <p-button
              type="submit"
              label="Unir Códigos"
              icon="pi pi-heart"
              [loading]="validandoCodigos"
              [disabled]="formUnirCodigos.invalid || validandoCodigos">
            </p-button>

            <p-button
              type="button"
              label="Limpiar"
              icon="pi pi-times"
              styleClass="p-button-outlined p-button-secondary"
              (click)="limpiarFormulario()">
            </p-button>
          </div>
        </form>

        <!-- Mensaje de éxito -->
        <div *ngIf="codigosValidos" class="mensaje-exito">
          <p-message
            severity="success"
            text="¡Códigos unidos exitosamente! Se ha creado la pareja.">
          </p-message>
        </div>
      </div>

      <!-- Generar mi código -->
      <div class="mi-codigo">
        <h5>Mi Código de Relación</h5>
        <p-message
          *ngIf="codigoRelacion"
          severity="info"
          [text]="'Tu código: ' + codigoRelacion">
        </p-message>

        <p-button
          *ngIf="!codigoRelacion"
          label="Generar Código"
          icon="pi pi-key"
          styleClass="p-button-outlined p-button-info"
          (click)="generarMiCodigo()"
          [loading]="loading">
        </p-button>
      </div>
    </p-card>
  </div>

  <!-- Con pareja -->
  <div *ngIf="!loading && !error && pareja && !disponibleParaPareja" class="con-pareja">

    <!-- Información general de la pareja -->
    <p-card header="Información de la Pareja">
      <div class="pareja-info">

        <!-- Estado de la relación -->
        <div class="estado-relacion">
          <p-tag
            [value]="getEstadoInfo().label"
            [icon]="getEstadoInfo().icon"
            [severity]="getEstadoInfo().color">
          </p-tag>
        </div>

        <!-- Tiempo juntos -->
        <div class="tiempo-juntos">
          <h5>Tiempo Juntos</h5>
          <p-chip
            [label]="calcularTiempoJuntos()"
            icon="pi pi-calendar">
          </p-chip>
        </div>

        <!-- Fecha de inicio -->
        <div class="fecha-inicio">
          <h5>Fecha de Inicio</h5>
          <p>{{ pareja.fechaCreacion | date:'dd/MM/yyyy' }}</p>
        </div>
      </div>
    </p-card>

    <!-- Información del compañero -->
    <p-card header="Tu Compañero/a">
      <div class="companero-info">

        <!-- Avatar y datos básicos -->
        <div class="companero-principal">
          <p-avatar
            [label]="getIniciales(companero)"
            size="large"
            shape="circle">
          </p-avatar>

          <div class="datos-companero">
            <h4>{{ getNombreCompleto(companero) }}</h4>
            <p class="username">{{ '@' + (companero?.username || '') }}</p>
          </div>
        </div>

        <!-- Detalles adicionales -->
        <div class="detalles-companero">
          <div class="detalle-item">
            <p-chip
              label="ID Usuario"
              icon="pi pi-user">
            </p-chip>
            <span>{{ companero?.id }}</span>
          </div>
        </div>
      </div>
    </p-card>

    <!-- Configuración de Pareja -->
    <p-card header="Configuración de Pareja">
      <div class="configuracion-pareja">

        <!-- Verificar Estado -->
        <div class="verificar-estado">
          <h5>Verificar Estado de Disponibilidad</h5>
          <p-button
            label="Verificar Estado"
            icon="pi pi-refresh"
            styleClass="p-button-outlined p-button-info"
            (click)="verificarEstadoManual()"
            [loading]="loading">
          </p-button>
        </div>

        <!-- Reconfigurar Códigos -->
        <div class="reconfigurar-codigos">
          <h5>Reconfigurar Relación</h5>
          <p class="descripcion-reconfig">
            Si necesitas reconfigurar la relación, puedes unir nuevos códigos.
          </p>

          <form [formGroup]="formUnirCodigos" (ngSubmit)="reconfigurarPareja()">
            <div class="campos-codigos-reconfig">
              <div class="campo-codigo">
                <label for="codigo1-reconfig">Primer Código:</label>
                <input
                  id="codigo1-reconfig"
                  type="text"
                  pInputText
                  formControlName="codigo1"
                  placeholder="Nuevo primer código"
                  [class.ng-invalid]="isFieldInvalid('codigo1')"
                  [class.ng-dirty]="isFieldInvalid('codigo1')"
                />
                <small *ngIf="isFieldInvalid('codigo1')" class="p-error">
                  {{ getFieldError('codigo1') }}
                </small>
              </div>

              <div class="campo-codigo">
                <label for="codigo2-reconfig">Segundo Código:</label>
                <input
                  id="codigo2-reconfig"
                  type="text"
                  pInputText
                  formControlName="codigo2"
                  placeholder="Nuevo segundo código"
                  [class.ng-invalid]="isFieldInvalid('codigo2')"
                  [class.ng-dirty]="isFieldInvalid('codigo2')"
                />
                <small *ngIf="isFieldInvalid('codigo2')" class="p-error">
                  {{ getFieldError('codigo2') }}
                </small>
              </div>
            </div>

            <div class="acciones-reconfig">
              <p-button
                type="submit"
                label="Reconfigurar Relación"
                icon="pi pi-cog"
                styleClass="p-button-warning"
                [loading]="validandoCodigos"
                [disabled]="formUnirCodigos.invalid || validandoCodigos">
              </p-button>

              <p-button
                type="button"
                label="Limpiar"
                icon="pi pi-times"
                styleClass="p-button-outlined p-button-secondary"
                (click)="limpiarFormulario()">
              </p-button>
            </div>
          </form>
        </div>

      </div>
    </p-card>

  </div>
</div>
