<div class="cita-detail-container">

  <!-- Estado de carga -->
  <div *ngIf="loading" class="loading-state">
    <i class="pi pi-spin pi-spinner loading-icon"></i>
    <p>Cargando detalles de la cita...</p>
  </div>

  <!-- Estado de error -->
  <div *ngIf="error && !loading" class="error-state">
    <p-card header="Error" styleClass="error-card">
      <i class="pi pi-exclamation-triangle error-icon"></i>
      <p>{{ error }}</p>
      <div class="error-actions">
        <p-button
          label="Reintentar"
          icon="pi pi-refresh"
          (onClick)="cargarCita()"
          size="small"
        />
        <p-button
          label="Volver"
          icon="pi pi-arrow-left"
          [outlined]="true"
          (onClick)="volver()"
          size="small"
        />
      </div>
    </p-card>
  </div>

  <!-- Contenido de la cita -->
  <div *ngIf="!loading && !error && cita" class="cita-detail-content">

    <!-- Header con navegación -->
    <div class="detail-header">
      <p-button
        icon="pi pi-arrow-left"
        [text]="true"
        (onClick)="volver()"
        pTooltip="Volver a la lista"
        size="small"
      />
      <h1>Detalles de la Cita</h1>
    </div>

    <!-- Información principal -->
    <p-card header="Información General" styleClass="info-card">
      <div class="cita-info-grid">

        <!-- Título y descripción -->
        <div class="info-section">
          <h2 class="cita-titulo">{{ cita.titulo }}</h2>
          <p *ngIf="cita.descripcion" class="cita-descripcion">{{ cita.descripcion }}</p>
          <p *ngIf="!cita.descripcion" class="no-descripcion">Sin descripción</p>
        </div>

        <!-- Estado -->
        <div class="info-section">
          <h3>Estado</h3>
          <div class="estado-container">
            <span class="estado-badge" [class]="getEstadoCssClass(cita.estado)">
              <i class="pi"
                 [class.pi-clock]="cita.estado === EstadoCita.PLANIFICADA"
                 [class.pi-check-circle]="cita.estado === EstadoCita.REALIZADA"
                 [class.pi-times-circle]="cita.estado === EstadoCita.CANCELADA">
              </i>
              {{ getEstadoText(cita.estado) }}
            </span>
          </div>
        </div>

        <!-- Fecha y hora -->
        <div class="info-section">
          <h3>Fecha y Hora</h3>
          <div class="fecha-info">
            <div class="fecha-item">
              <i class="pi pi-calendar"></i>
              <span>{{ formatDate(cita.fecha) }}</span>
            </div>
            <div class="fecha-item">
              <i class="pi pi-clock"></i>
              <span>{{ formatTime(cita.fecha) }}</span>
            </div>
          </div>
        </div>

        <!-- Lugar -->
        <div class="info-section" *ngIf="cita.lugarNombre">
          <h3>Lugar</h3>
          <div class="lugar-info">
            <i class="pi pi-map-marker"></i>
            <span>{{ cita.lugarNombre }}</span>
          </div>
        </div>

        <!-- Categoría -->
        <div class="info-section" *ngIf="cita.categoriaNombre">
          <h3>Categoría</h3>
          <div class="categoria-info">
            <i class="pi pi-tag"></i>
            <span>{{ cita.categoriaNombre }}</span>
          </div>
        </div>

        <!-- Calificación -->
        <div class="info-section" *ngIf="cita.rating">
          <h3>Calificación</h3>
          <div class="rating-info">
                          <p-rating
                [ngModel]="cita.rating"
                [readonly]="true"
                styleClass="rating-display"
              />
            <span class="rating-text">{{ cita.rating }}/5</span>
          </div>
        </div>

      </div>
    </p-card>

    <!-- Acciones -->
    <p-card header="Acciones" styleClass="actions-card">
      <div class="actions-grid">

        <!-- Acciones principales -->
        <div class="action-group" *ngIf="puedeEditar()">
          <p-button
            label="Editar Cita"
            icon="pi pi-pencil"
            (onClick)="editarCita()"
            styleClass="action-btn edit-btn"
          />
        </div>

        <div class="action-group" *ngIf="puedeCompletar()">
          <p-button
            label="Marcar como Completada"
            icon="pi pi-check"
            severity="success"
            (onClick)="completarCita()"
            styleClass="action-btn complete-btn"
          />
        </div>

        <div class="action-group" *ngIf="puedeCalificar()">
                      <p-button
              label="Calificar"
              icon="pi pi-star"
              severity="contrast"
              (onClick)="mostrarDialogoRating()"
              styleClass="action-btn rating-btn"
            />
        </div>

        <!-- Acciones de eliminación -->
        <div class="action-group action-group-destructive">
                      <p-button
              label="Cancelar Cita"
              icon="pi pi-times"
              severity="secondary"
              [outlined]="true"
              (onClick)="cancelarCita()"
              styleClass="action-btn cancel-btn"
              *ngIf="puedeCancelar()"
            />

          <p-button
            label="Eliminar"
            icon="pi pi-trash"
            severity="danger"
            [outlined]="true"
            (onClick)="eliminarCita()"
            styleClass="action-btn delete-btn"
          />
        </div>

      </div>
    </p-card>

  </div>

  <!-- Diálogo de calificación -->
  <p-dialog
    header="Calificar Cita"
    [(visible)]="showRatingDialog"
    [modal]="true"
    [closable]="true"
    [draggable]="false"
    [resizable]="false"
    styleClass="rating-dialog"
  >
    <div class="rating-dialog-content">
      <h3>¿Cómo fue tu cita?</h3>
      <p>Dale una calificación del 1 al 5:</p>

      <div class="rating-section">
        <p-rating
          [(ngModel)]="rating"
          styleClass="rating-input"
        />
        <span class="rating-value">{{ rating }}/5</span>
      </div>

      <div class="rating-comment-section">
        <label for="ratingComment">Comentario (opcional):</label>
        <textarea
          id="ratingComment"
          pInputTextarea
          [(ngModel)]="ratingComment"
          placeholder="Cuéntanos sobre tu experiencia..."
          rows="3"
          class="rating-comment"
        ></textarea>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          label="Cancelar"
          [text]="true"
          (onClick)="cerrarDialogoRating()"
        />
        <p-button
          label="Guardar Calificación"
          icon="pi pi-check"
          (onClick)="calificarCita()"
          [disabled]="rating === 0"
        />
      </div>
    </ng-template>
  </p-dialog>

  <!-- Diálogo de confirmación -->
  <p-confirmDialog></p-confirmDialog>

</div>
