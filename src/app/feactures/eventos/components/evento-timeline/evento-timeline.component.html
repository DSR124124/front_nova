<div class="evento-timeline-container">
  <p-card header="Línea de Tiempo de Eventos" styleClass="timeline-card">

    <!-- Loading Spinner -->
    <div *ngIf="loading" class="loading-container">
      <p-progressSpinner />
    </div>

    <!-- Contenido principal -->
    <div *ngIf="!loading">

      <!-- Header con controles -->
      <div class="timeline-header">
        <h2>Cronología de Eventos</h2>
        <div class="view-controls">
          <p-button
            [icon]="viewMode === 'chronological' ? 'pi pi-calendar' : 'pi pi-calendar-times'"
            [severity]="viewMode === 'chronological' ? 'primary' : 'secondary'"
            (onClick)="cambiarVista('chronological')"
            size="small"
            [pTooltip]="'Vista cronológica'"
          />
          <p-button
            [icon]="viewMode === 'grouped' ? 'pi pi-calendar' : 'pi pi-calendar-times'"
            [severity]="viewMode === 'grouped' ? 'primary' : 'secondary'"
            (onClick)="cambiarVista('grouped')"
            size="small"
            [pTooltip]="'Vista agrupada'"
          />
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters-section">
        <!-- Búsqueda -->
        <div class="search-section">
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input
              type="text"
              pInputText
              placeholder="Buscar eventos..."
              [(ngModel)]="searchTerm"
              (input)="onSearchChange()"
              class="search-input"
            />
          </span>
        </div>

        <!-- Filtros de tipo y período -->
        <div class="filter-controls">
          <p-dropdown
            [options]="tipoOptions"
            [(ngModel)]="selectedTipo"
            (onChange)="onTipoChange()"
            placeholder="Tipo de evento"
            styleClass="filter-dropdown"
          />

          <p-dropdown
            [options]="periodoOptions"
            [(ngModel)]="selectedPeriodo"
            (onChange)="onPeriodoChange()"
            placeholder="Período"
            styleClass="filter-dropdown"
          />

          <p-button
            label="Limpiar filtros"
            icon="pi pi-refresh"
            severity="secondary"
            (onClick)="limpiarFiltros()"
            size="small"
          />
        </div>

        <!-- Controles de agrupación (solo en vista agrupada) -->
        <div *ngIf="viewMode === 'grouped'" class="grouping-controls">
          <span class="grouping-label">Agrupar por:</span>
          <p-button
            [icon]="groupBy === 'month' ? 'pi pi-calendar' : 'pi pi-calendar-times'"
            [severity]="groupBy === 'month' ? 'primary' : 'secondary'"
            (onClick)="cambiarAgrupacion('month')"
            size="small"
            [pTooltip]="'Por mes'"
          />
          <p-button
            [icon]="groupBy === 'year' ? 'pi pi-calendar' : 'pi pi-calendar-times'"
            [severity]="groupBy === 'year' ? 'primary' : 'secondary'"
            (onClick)="cambiarAgrupacion('year')"
            size="small"
            [pTooltip]="'Por año'"
          />
          <p-button
            [icon]="groupBy === 'type' ? 'pi pi-calendar' : 'pi pi-calendar-times'"
            [severity]="groupBy === 'type' ? 'primary' : 'secondary'"
            (onClick)="cambiarAgrupacion('type')"
            size="small"
            [pTooltip]="'Por tipo'"
          />
        </div>
      </div>

      <!-- Información de resultados -->
      <div class="results-info">
        <p>Mostrando {{ eventosFiltrados.length }} de {{ eventos.length }} eventos</p>
      </div>

      <!-- Timeline de eventos -->
      <div class="timeline-content">

        <!-- Vista cronológica -->
        <div *ngIf="viewMode === 'chronological'" class="chronological-timeline">
          <div
            *ngFor="let item of getEventosAgrupados(); let i = index"
            class="timeline-item"
            [ngClass]="{
              'past': item.esPasado,
              'future': !item.esPasado,
              'today': getDiasRestantes(item.evento.fecha) === 0
            }"
          >
            <div class="timeline-marker">
              <div class="marker-dot"></div>
              <div class="marker-line" *ngIf="i < getEventosAgrupados().length - 1"></div>
            </div>

            <div class="timeline-content">
              <div class="evento-card">
                <div class="evento-header">
                  <p-tag
                    [value]="item.evento.tipo || 'Evento'"
                    [severity]="getTipoColor(item.evento.tipo)"
                    [icon]="getTipoIcono(item.evento.tipo)"
                    size="small"
                  />
                  <div class="evento-actions">
                    <p-button
                      icon="pi pi-eye"
                      severity="info"
                      size="small"
                      (onClick)="verDetalle(item.evento)"
                      [pTooltip]="'Ver detalle'"
                    />
                    <p-button
                      icon="pi pi-pencil"
                      severity="secondary"
                      size="small"
                      (onClick)="editarEvento(item.evento)"
                      [pTooltip]="'Editar'"
                    />
                    <p-button
                      icon="pi pi-trash"
                      severity="danger"
                      size="small"
                      (onClick)="eliminarEvento(item.evento)"
                      [pTooltip]="'Eliminar'"
                    />
                  </div>
                </div>

                <div class="evento-body">
                  <h3 class="evento-titulo">{{ item.evento.titulo }}</h3>
                  <p class="evento-descripcion" *ngIf="item.evento.descripcion">
                    {{ item.evento.descripcion }}
                  </p>

                  <div class="evento-info">
                    <div class="info-item">
                      <i class="pi pi-calendar"></i>
                      <span>{{ formatearFecha(item.evento.fecha) }}</span>
                    </div>
                    <div class="info-item">
                      <i class="pi pi-clock"></i>
                      <span>{{ formatearHora(item.evento.fecha) }}</span>
                    </div>
                    <div class="info-item" *ngIf="item.evento.lugarNombre">
                      <i class="pi pi-map-marker"></i>
                      <span>{{ item.evento.lugarNombre }}</span>
                    </div>
                  </div>

                  <div class="evento-timeline-info">
                    <p-tag
                      [value]="getEstadoEvento(item.evento.fecha).texto"
                      [severity]="getEstadoEvento(item.evento.fecha).severity"
                      size="small"
                    />
                    <span class="dias-restantes">{{ getDiasRestantesTexto(item.evento.fecha) }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista agrupada -->
        <div *ngIf="viewMode === 'grouped'" class="grouped-timeline">
          <div
            *ngFor="let grupo of getEventosAgrupados()"
            class="timeline-group"
          >
            <div class="group-header">
              <h3 class="group-title">{{ grupo.clave }}</h3>
              <span class="group-count">{{ grupo.eventos.length }} evento(s)</span>
            </div>

            <div class="group-events">
              <div
                *ngFor="let evento of grupo.eventos; let i = index"
                class="timeline-item"
                [ngClass]="{
                  'past': getDiasRestantes(evento.fecha) < 0,
                  'future': getDiasRestantes(evento.fecha) >= 0,
                  'today': getDiasRestantes(evento.fecha) === 0
                }"
              >
                <div class="timeline-marker">
                  <div class="marker-dot"></div>
                  <div class="marker-line" *ngIf="i < grupo.eventos.length - 1"></div>
                </div>

                <div class="timeline-content">
                  <div class="evento-card">
                    <div class="evento-header">
                      <p-tag
                        [value]="evento.tipo || 'Evento'"
                        [severity]="getTipoColor(evento.tipo)"
                        [icon]="getTipoIcono(evento.tipo)"
                        size="small"
                      />
                      <div class="evento-actions">
                        <p-button
                          icon="pi pi-eye"
                          severity="info"
                          size="small"
                          (onClick)="verDetalle(evento)"
                          [pTooltip]="'Ver detalle'"
                        />
                        <p-button
                          icon="pi pi-pencil"
                          severity="secondary"
                          size="small"
                          (onClick)="editarEvento(evento)"
                          [pTooltip]="'Editar'"
                        />
                        <p-button
                          icon="pi pi-trash"
                          severity="danger"
                          size="small"
                          (onClick)="eliminarEvento(evento)"
                          [pTooltip]="'Eliminar'"
                        />
                      </div>
                    </div>

                    <div class="evento-body">
                      <h3 class="evento-titulo">{{ evento.titulo }}</h3>
                      <p class="evento-descripcion" *ngIf="evento.descripcion">
                        {{ evento.descripcion }}
                      </p>

                      <div class="evento-info">
                        <div class="info-item">
                          <i class="pi pi-calendar"></i>
                          <span>{{ formatearFecha(evento.fecha) }}</span>
                        </div>
                        <div class="info-item">
                          <i class="pi pi-clock"></i>
                          <span>{{ formatearHora(evento.fecha) }}</span>
                        </div>
                        <div class="info-item" *ngIf="evento.lugarNombre">
                          <i class="pi pi-map-marker"></i>
                          <span>{{ evento.lugarNombre }}</span>
                        </div>
                      </div>

                      <div class="evento-timeline-info">
                        <p-tag
                          [value]="getEstadoEvento(evento.fecha).texto"
                          [severity]="getEstadoEvento(evento.fecha).severity"
                          size="small"
                        />
                        <span class="dias-restantes">{{ getDiasRestantesTexto(evento.fecha) }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Estado vacío -->
        <div *ngIf="eventosFiltrados.length === 0" class="empty-state">
          <i class="pi pi-calendar-times empty-icon"></i>
          <h3>No se encontraron eventos</h3>
          <p>Intenta ajustar los filtros de búsqueda</p>
        </div>
      </div>

    </div>

  </p-card>
</div>

<!-- Toast para mensajes -->
<p-toast />

<!-- Diálogo de confirmación -->
<p-confirmDialog />
